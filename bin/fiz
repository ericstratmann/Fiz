#! /bin/sh

FIZ_HOME=@@FIZ_HOME
FIZ_REPO=@@FIZ_REPO

print_usage()
{
    echo "Usage: fiz <subcommand> [options] [args]\n\n\
Subcommands:\n\
\thelp\t\tPrint this message and exit.
\tversion\t\tPrint the version of the Fiz platform or a Fiz application.
\t\t\tTo print the version of a specific Fiz installation or a Fiz application,
\t\t\tprovide the path to the root directory of that intallation or application.
\t\t\tOtherwise, the version of the default Fiz installation is printed.
\tcreate\t\tCreate a new Fiz application. Provide the path to application's
\t\t\tdirectory.
\tfetch\t\tFetch and unpack a new version of the Fiz platform. Provide the version
\t\t\tnumber of specific version you want fetch, and optionally a destination
\t\t\tdirectory for the new installation.
\tupgrade\t\tUpgrade the Fiz-specific files of an application to a specific 
\t\t\tversion. Provide the version number of the specific version of Fiz and 
\t\t\trun this command at the root directory of the application.\n"
    return
}

absolute_path()
{
    case "$1" in
	/*) 
	    abs="$1"
	    ;;
	*) 
	    abs="$PWD/$1"
	    ;;
    esac

    echo $abs
}

if [ $# -lt 1 ]; then
    echo "Type 'fiz help' for usage."
    exit 1
fi

case "$1" in
    "help")
	print_usage
	;;
    "create")
	if [ $# -ne 2 ]; then
	    print_usage
	    exit 1
	fi
	dest_dir=`absolute_path "$2"`
	ant -buildfile $FIZ_HOME/antscripts/create.xml -Dfizhome="$FIZ_HOME" -Ddestdir="$dest_dir"
	;;
    "fetch")
	if [ $# -eq 2 ]; then
	    ant -buildfile $FIZ_HOME/antscripts/fetch.xml -Dfizhome="$FIZ_HOME" -Dfizrepository="$FIZ_REPO" -Dversion="$2"
	elif [ $# -eq 3 ]; then
	    dest_dir=`absolute_path "$3"`
	    ant -buildfile $FIZ_HOME/antscripts/fetch.xml -Dfizrepository="$FIZ_REPO" -Dversion="$2" -Ddestdir="$dest_dir"
	else
	    print_usage
	    exit 1
	fi
	;;
    "upgrade")
	if [ $# -eq 1 ]; then
	    ant -buildfile antscripts/upgrade.xml -Dfizhome="$FIZ_HOME"
	elif [ $# -eq 2 ]; then
	    ant -buildfile antscripts/upgrade.xml upgradetoversion -Dfizrepository="$FIZ_REPO" -Dversion="$2"
	else 
	    print_usage
	    exit 1
	fi
	;;
    "version")
	if [ $# -eq 1 ]; then
	    ant -buildfile $FIZ_HOME/antscripts/version.xml -Dfiz.jar.path="$FIZ_HOME/lib/fiz.jar"
	elif [ $# -eq 2 ]; then
	    abs_path=`absolute_path "$2"`
	    ant -buildfile $FIZ_HOME/antscripts/version.xml -Dfiz.jar.path="$abs_path/lib/fiz.jar"
	else
	    print_usage
	    exit 1
	fi
	;;
    *)
	print_usage
	exit 1
	;;
esac

exit 0
